<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/app.c0f892a0ecdf2a427017.css">code[class*=language-],pre[class*=language-]{color:#fff;background:none;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;-webkit-font-feature-settings:normal;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{overflow:auto;padding:1em}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}:not(pre)>code[class*=language-]{border-radius:.3em;background:rgba(255,229,100,.2);color:#1a1a1a;padding:.15em .2em .05em;white-space:normal}.token.attr-name{color:#addb67;font-style:italic}.token.comment{color:#637777}.token.string,.token.url{color:#addb67}.token.variable{color:#d6deeb}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.punctuation{color:#c792ea}.token.doctype,.token.selector{color:#c792ea;font-style:"italic"}.token.class-name{color:#ffcb8b}.token.keyword,.token.operator,.token.tag{color:#ffa7c4}.token.boolean{color:#ff5874}.token.property{color:#80cbc4}.token.namespace{color:#b2ccd6}pre[data-line]{padding:1em 0 1em 3em;position:relative}.gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:.75em;border-left:.25em solid #ffa7c4}.gatsby-highlight{margin-bottom:1.75rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}.gatsby-highlight pre[class*=language-]{float:left;min-width:100%}</style><style data-href="/0.45ed6d11525cba30923e.css">pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}</style><meta name="generator" content="Gatsby 2.0.76"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><title data-react-helmet="true">QRN更新方案 | gtts的博客</title><meta data-react-helmet="true" name="description" content="名词解释 QP 包: qunar 自定义的一种文件格式，类似zip 包，会将静态资源（js,css,png等）打包成一个文件 vid：类似版本号，整型类型，随着客户端发版递增，用来做版本控制 背景 在大前端的环境下，跨平台和动态更新是两个绕不过去话题。2014年Qunar 在Hybrid…"/><meta data-react-helmet="true" property="og:title" content="QRN更新方案"/><meta data-react-helmet="true" property="og:description" content="名词解释 QP 包: qunar 自定义的一种文件格式，类似zip 包，会将静态资源（js,css,png等）打包成一个文件 vid：类似版本号，整型类型，随着客户端发版递增，用来做版本控制 背景 在大前端的环境下，跨平台和动态更新是两个绕不过去话题。2014年Qunar 在Hybrid…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="gtts"/><meta data-react-helmet="true" name="twitter:title" content="QRN更新方案"/><meta data-react-helmet="true" name="twitter:description" content="名词解释 QP 包: qunar 自定义的一种文件格式，类似zip 包，会将静态资源（js,css,png等）打包成一个文件 vid：类似版本号，整型类型，随着客户端发版递增，用来做版本控制 背景 在大前端的环境下，跨平台和动态更新是两个绕不过去话题。2014年Qunar 在Hybrid…"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><link as="script" rel="preload" href="/component---src-templates-blog-post-js-a7f689111f7c2a79dcfc.js"/><link as="script" rel="preload" href="/0-d14fd4fa07a09eb3740f.js"/><link as="script" rel="preload" href="/app-d87cf20a72d107b4f99a.js"/><link as="script" rel="preload" href="/webpack-runtime-364d645fac78fecf4cff.js"/><link as="fetch" rel="preload" href="/static/d/233/path---2018-08-10-qrn-update-3-b-0-544-Sie4oUx6YwJRqr1TEws91yhQc.json" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div style="margin-left:auto;margin-right:auto;max-width:49rem;padding:2.625rem 1.3125rem"><h3 style="font-family:Montserrat, sans-serif;margin-top:0;margin-bottom:1.75rem"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">gtts的博客</a></h3><h1>QRN更新方案</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem;margin-top:-1.75rem">August 10, 2018</p><div><p><strong>名词解释</strong></p>
<blockquote>
<p>QP 包: qunar 自定义的一种文件格式，类似zip 包，会将静态资源（js,css,png等）打包成一个文件</p>
</blockquote>
<blockquote>
<p>vid：类似版本号，整型类型，随着客户端发版递增，用来做版本控制</p>
</blockquote>
<h2>背景</h2>
<p>在大前端的环境下，跨平台和动态更新是两个绕不过去话题。2014年Qunar 在Hybrid 框架上开始投入研发，最终得到大面积的推广应用，得益于动态更新技术，前端做到了灵活发布，不再受制于客户端发版限制。 到了2015年Facebook开源了React Native(RN) ，Qunar 第一时间开始调研，认为RN 是Hybrid 的方案的一个补充，可以用在对性能要求更高的地方，随后我们在RN 的基础上做了大量改进，研发出了QRN 框架，而动态更新方案也同样适用于QRN，使得QRN 项目也可以做到灵活发版，快速迭代。</p>
<p>对RN 来说，在没有动态更新技术的情况下，也可以通过以下两种方式达到开发目的：</p>
<p>方案1：将js 资源打包到客户端项目里，跟随客户端发版；</p>
<p>方案2：将js 资源发到线上，每次打开客户端时，请求js 资源，再加载运行。 </p>
<p>如果再进一步，对<em>方案2</em>加一个缓存策略，这算是最小可用的一个动态更新方案了。但是针对移动端复杂场景，还远远达不到我们的要求，经过不断迭代，Qunar 有了更完善的动态更新方案，下面我将和大家分享一下QRN 的更新机制。</p>
<h2>最小化解决方案</h2>
<p>动态更新主要解决了<code class="language-text">版本控制</code>、<code class="language-text">页面加载慢</code>和<code class="language-text">灵活发版</code>的问题。</p>
<h4>1、解决版本控制问题</h4>
<p>版本控制问题归根结底就是指定版本的客户端能下载到合适的最新QP 包。如果做不好版本控制，可能会引起线上故障，想象一个场景，Native 在最新版本提供了一个新插件供RN 使用，在最近一次迭代时RN 项目使用了这个新插件，那么将这个RN 项目发出去之后，如果让老版本的客户端运行了这个最新的RN 项目代码，因兼容性问题将会引起不可预知的故障。</p>
<p>我们解决版本控制问题的思路是，配置一个客户端的vid 字段，然后通过这个配置打出的QP 包，能被所有比指定vid 大的客户端下载，当有新的QP 包更适合指定vid 客户端时，服务端会下发最新的QP 包。</p>
<p>vid配置如下所示：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">iOS_vid</span> <span class="token punctuation">:</span> vid_10
<span class="token key atrule">android_vid</span> <span class="token punctuation">:</span> vid_10<span class="token punctuation">,</span>com.qunar.module_1<span class="token punctuation">,</span>com.qunar.module_2 </code></pre></div>
<blockquote>
<p>注：Android 大点的项目有<code class="language-text">native 模块</code>的动态热发，所以比起iOS 多了组件版本项。</p>
</blockquote>
<p>还有一种场景我们经常遇到，要求修复指定版本的bug 时，该如何处理呢？我们采取的解决方案是vid 字段可以配置区间，这样就只用vid 落到区间里的客户端能下载到bugfix 的QP 包。 Vid配置如下所示, 版本9和10可以下载到：</p>
<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">iOS_vid</span> <span class="token punctuation">:</span> vid_9<span class="token punctuation">-</span>vid_10</code></pre></div>
<h4>2、解决页面加载慢问题</h4>
<p>针对页面加载慢，我们可以通过缓存策略，将本来应该从线上请求的资源，在本地存在的情况下直接从本地获取，本地不存在再去线上请求。如下图所示： </p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/72a4b7124bfb84a4db5e3d6b24955d40/599ff/01.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 59.976931949250286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAAB8UlEQVQoz3VSXW/TMBTNP+Pn8AS/YE888cJ+wMQQQrxO04RAAjFgGu26QdEkunUrS7/TOHWbOIkdfzvcNCmwByzLvvI9x/dcH3vlP8NtVqk0WtE5yqeLbBSkOGblf4Z3j+wqeohw69ug9d1vdf3OD/96MO7OTk6Hby6mH9ujd2fj90LzGu5tWRY2peRsOjO8sFLKnClbGsa0VvvtJ08/PNw72dk9frx7/CjjSc25V1kac/mlI2YLiG2ewWoYddbWWcWZ5twy9qfFiszT4K7zmgyOxPitGR6WwSdnjFnhilywEsjOwb1i5NsstbyotTZkkQXTi1eL85fo7IWcHJXrlgOt/i+tlID60JK1KYklDp0QMksFnAvBOf8r21JmErJOizhlnFJXMJJlJEIWipeOcLvfxrfzTJE4WmKEUJIkXi1AY6SCWRpFQTCHxAqhumerJL+5KvPk+Vf04Flv58AX/avGlY3sKoA6KpiK7nnjmVaW0caHCumoMHufJ6NFWnLqmmPnGes0THgPQgTG2pUGckLoCLut9wpAoG5yZ5ahWMV6+yO8mEowNOcqZ4IqW2iHSf7z+rbX69/448tefzgJAACVAZDnnOaMcF1IU5HzTdRMobi0GRPhch3i9XJN5uEyWiUcLpWGAUCZQlvKtdSV+b8BaOajtcwu10YAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/72a4b7124bfb84a4db5e3d6b24955d40/fb8a0/01.png"
        srcset="/static/72a4b7124bfb84a4db5e3d6b24955d40/1a291/01.png 148w,
/static/72a4b7124bfb84a4db5e3d6b24955d40/2bc4a/01.png 295w,
/static/72a4b7124bfb84a4db5e3d6b24955d40/fb8a0/01.png 590w,
/static/72a4b7124bfb84a4db5e3d6b24955d40/526de/01.png 885w,
/static/72a4b7124bfb84a4db5e3d6b24955d40/fa2eb/01.png 1180w,
/static/72a4b7124bfb84a4db5e3d6b24955d40/599ff/01.png 1734w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p><code class="language-text">步骤1</code>先发起一个网络请求没有直接从服务端获取数据，而是通过<code class="language-text">步骤2</code>经过了“网络请求拦截器”，再经过“拦截过滤器”进行一次摔选，保证本地有资源的情况下，直接从本地拿数据，在本地构造一个Response 完成网络请求，本地没有数据的情况下，通过<code class="language-text">步骤7</code>从线上获取资源，这样就在数据获取方面做到了最快。</p>
<h4>3、解决发版灵活问题</h4>
<p>针对灵活发版，我们先给出一个最小化解决方案。 我们的业务代码一般放在gitlab，当代码开发完成之后接着就是打包，生成一个可供客户端下载的包（即QP 包），这个包需要一个服务端来做版本控制，我们暂且叫QP Server，最后客户端通过一定的更新策略，就可以更新到合适的QP 包，当本地有包了，就按前面介绍的缓存策略来加载资源，如下图所示。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/fbdbfadd25fd058449699ea1839be2cc/bb278/02.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 63.58695652173913%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAByklEQVQoz5VSy0tVQRi//0n/Q7gLItrbJgghKLCN1MoWtbogFZILN1HuXJQSgi0q7AEHKiJbSJpWp/BxMzp69d5z5sw5c+Y9Z2aaOSe6mkL2rebx/R7fb6Zh95Yxlu9avmUVsUeoxr6d5vninfbrps1WKi79b7Dxkk7UgenO25Hvc5dNvFBhS7O/23hv5nBlyiSFLUvWUQ7M3zLm4LohVdmFaKub5piCnCvtLwCSiPJ2AhFhPWpBfiRrHbRdu/RgrY3rgAWJM0p4WZ8yUcaQOjompLF+8tXux5vBxRvBhebLgakPY7qKo2c7K9jP3WSzHXfSXJU6RUJXLrTxjPOt54Mzfdee9g/Nnhh5cV4q8RucFPJVCN6vQcIlE4JL5aZCVOHaiHdpKNdfosXHS5NB+AhiUIfnwUEIz058uzK9gbmuH9uVZDSNgUvcbd0U7TiLdrIcaYwdkeqlHXzNLj3YGJ7dRKysoyTvpuDdc2C8Hz0cLqJV15tjHHUSLoXxdKYHfvYpPXMvHLy/njNPqQUDo6dA83h6+3R89Rh+M1n9n/LwTzK33D05ujAwsfJHWUafiye30Mx1Mj9tBDvwznvAiKlwG7U6xBj7X/UL1PPTuUHIzAYAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/fbdbfadd25fd058449699ea1839be2cc/fb8a0/02.png"
        srcset="/static/fbdbfadd25fd058449699ea1839be2cc/1a291/02.png 148w,
/static/fbdbfadd25fd058449699ea1839be2cc/2bc4a/02.png 295w,
/static/fbdbfadd25fd058449699ea1839be2cc/fb8a0/02.png 590w,
/static/fbdbfadd25fd058449699ea1839be2cc/526de/02.png 885w,
/static/fbdbfadd25fd058449699ea1839be2cc/fa2eb/02.png 1180w,
/static/fbdbfadd25fd058449699ea1839be2cc/bb278/02.png 1472w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>仅通过上图所示方式，当<code class="language-text">QP Server</code>故障或者网络慢时，客户端将下载不到QP 包，这时应该考虑一个应对这种情况的方案，当本地获取不了资源时，会从线上获取，这个在“解决加载慢问题”的图片中也是可以看出来的。在上图方案的基础上，我们在打包环节加一些步骤，先将qrn 代码打包成jsbundle 上传到<code class="language-text">jsbundle Server</code>， 接着再打出QP 包，这样就可以保证客户端在下载不到QP 包时，可以通过<code class="language-text">jsbundle Server</code> 直接加载js。如下图所示：</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/3dcff61d24e6ac95c7c37a10409cc72f/73823/03.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 55.12367491166078%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAAB/klEQVQoz1WRz2sTQRTH878oeBIvgvgPWC+evQniwb+gBUtBRKHUS+tJTwq2JE3ViihCWtAi1bapScE2FCM1jYmb7M7+mtmdmZ1fO84ka8THzDDzeJ/3fe9NSReW2x0fq957TYdjl3T6cjgUvWO8vUgay9IdSM8Vve5fRJcsk5tlYdhablevK1AfJ5PAZmFe/aBy83RzVovQPIU7yJUyhNKqNFE20YnbYr9qBDqFMhjmUmmR0B+r3PlYBAbhKHakLIR0Q+jHCGFOMmlcUcphQnyEmTvQ0noQlkkmTXVK57uN8vP6/OrB0qGzUzIlYJqlhIKIcMGVFJjyEBIqBPeM8hhmnb7r+TFA4O7K1O21S7eqF+/VbpTGFdBMgijpe6EXIS5EjOiobLeAUwpjxAnGmWoffX7TfLbZehXj0Pb86Xs8XT3ZPUHmrkb9IJZnZgwBKGChqbQjhJR3D9sJFCwzDeUWLu+BK4ut9aZv1cx4f+7Hr+/HbxfYty3CpEj8aONJtDaHdl5IwaPuKTPo5KvKde/qo6P1JrA/wbLg4ZQ/c86fOevPX4NKw62nwfSZYO4CmD3POl9zhHMp/sErX5zLD/Ze7ruFcqeRvFtIa0u0+UFRJnwn3XiMKnfwdkWlSAx+26lPYMzkIKKUS/2/5YTIACgIFWEqJeaUUagSOAn4AzEIVLX+Q/6PAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/3dcff61d24e6ac95c7c37a10409cc72f/fb8a0/03.png"
        srcset="/static/3dcff61d24e6ac95c7c37a10409cc72f/1a291/03.png 148w,
/static/3dcff61d24e6ac95c7c37a10409cc72f/2bc4a/03.png 295w,
/static/3dcff61d24e6ac95c7c37a10409cc72f/fb8a0/03.png 590w,
/static/3dcff61d24e6ac95c7c37a10409cc72f/526de/03.png 885w,
/static/3dcff61d24e6ac95c7c37a10409cc72f/fa2eb/03.png 1180w,
/static/3dcff61d24e6ac95c7c37a10409cc72f/73823/03.png 1698w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>做到这些，我们已经有了最小可用方案了，但是在实践过程中，总会有各种各样的情况出现，比如：</p>
<ul>
<li>安全性如何保证，QP 包被人篡改了会怎么样？</li>
<li>如果线上出了故障，怎么快速解决？</li>
<li>发了新版本更新率低，想提高搞更新率怎么办？</li>
<li>想要灰度发布，怎么办？</li>
<li>……</li>
</ul>
<p>面对这一系列的问题，我们不断改进更新机制，下面我会挑重点进行分享。</p>
<h2>QP 包如何保证安全</h2>
<p>QP 包的安全问题主要表现在传输安全、存储安全和包完整性上, 若被中间人攻击替换代码，会造成较大的危害，传输方面，我们采用HTTPS 以及客户端到服务端请求参数加密的形式来保证安全。在存储安全和完整性校验上，我们采用了RSA 校验方式，可以参考下图。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/8ac28d5a4d1e454abeb22d1f5f91b544/00e33/04.jpg"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 51.49425287356322%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VgUf//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAAICAwAAAAAAAAAAAAAAAAARARAhMWH/2gAIAQEAAT8hY8bH2or/2gAMAwEAAgADAAAAEHP/AP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAAIDAAMAAAAAAAAAAAAAAAABETFBYXGB/9oACAEBAAE/ELXC8EqbU2xcBhV9kH//2Q=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/8ac28d5a4d1e454abeb22d1f5f91b544/f8fb9/04.jpg"
        srcset="/static/8ac28d5a4d1e454abeb22d1f5f91b544/e8976/04.jpg 148w,
/static/8ac28d5a4d1e454abeb22d1f5f91b544/63df2/04.jpg 295w,
/static/8ac28d5a4d1e454abeb22d1f5f91b544/f8fb9/04.jpg 590w,
/static/8ac28d5a4d1e454abeb22d1f5f91b544/00e33/04.jpg 870w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<ul>
<li>1、请求url </li>
<li>2、job打QP 包 </li>
<li>3、通过私钥加密QP </li>
<li>4、生成加密后的md5</li>
<li>5、将QP和md5等上传到更新服务器</li>
<li>6、客户端请求</li>
<li>7、客户端计算QP 包的md5</li>
<li>8、客户端通过公钥解密从服务端拿到的加密的md5</li>
<li>9、对比7和8两步的MD5 值， 若相等，则校验通过</li>
</ul>
<p>从图中可以看出，我们用到了差分（bsdiff）更新方案，客户端本地存在老版本QP 包时，只需要下载新版本和老版本的差分数据，在客户端把差分数据和老版本做一个patch，就可以得到新版本，同时通过MD5校验，可以检验合并是否成功，如果不成功，再去下载全量的新版本QP 包。</p>
<h2>更新机制的完善</h2>
<p>经过不断完善，有很多细节上面的优化，从大的方面来看QRN 的更新机制主要有：</p>
<ul>
<li>WiFi 下的全量更新</li>
<li>任意网络下的单项更新</li>
<li>强制更新</li>
<li>下线回滚等</li>
</ul>
<h4>1、WiFi下的全量更新</h4>
<p>目前系统有接近100个QP 包，每个<code class="language-text">1M</code> 左右，在考虑到为用户省流量的情况下，我们不能在任意网络情况下都去下载QP 包，所以只在WiFi环境下进行所有QP 包的下载，逻辑如下图所示。 </p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/05bb2784942cbe74fc94d0704c08d1c5/0a94b/05.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 62.2969837587007%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACIklEQVQoz1VRz08TQRTuX+bJo/FoooGEv8ADxhgPntTEVBJNVDTIAUMCXExMKNBgoUDVRqxFFFuoa+lSdrptd7q7M7s7Ozs/1tm2lPoymbw38773fe+9VDwyKZMbuazTFnYvdmDsoRg5rAeZ60Rtk1ldjlE8ZinGBabMJ5QGpNm2dcOiCDdBd79y9v3EONIA930ZhtzzROBLSv8D71aNyTcf7y1/+q2d35rdvP5849Tovs0dXn26duNFdmJ2kzKeyBrTNzgJOGLc9ojrh0JKHEQOCrngKqy3YK5UPWmcCyFUnmDStVEP2oxyKZJQcJnS2s70cnF66cufMzOmAXWx7zqxpOvl+pUnGd3CfTapAJqmHfw48DwvqSX6YEJZDfRqAConERfxgUIA0WL+MHnsm0r1/UCZbdsWtEhAVLnUaMx/u2jnuLX1C+gQb1eMm69ztxfyU/O7TZiQcyYRQoQQ1UUURXLAnHz00e8KxxMvNyZfZee2jyqgl14vz2S+ptdKHUwGzBDCarVSq9Xqp3WMsZKZuphhUiDEiJJQhd/0bjpTfvy++PDDPnAD9cKY7HQsYJhtswNAy+45l2AlqaHrEBiCJ4vZ08y7y58frOzdWSrUTHjRWSwiOfQGqxrOQwiEMXEdEVGra0lOi1rr/krhRG+awFjI/3y0epApN8YXfgkeiuecB74qEVOyWKhee5Y9arTj0J9ZLU3Nbc3vVAYNjvL/AdAijK9LBSCzAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/05bb2784942cbe74fc94d0704c08d1c5/fb8a0/05.png"
        srcset="/static/05bb2784942cbe74fc94d0704c08d1c5/1a291/05.png 148w,
/static/05bb2784942cbe74fc94d0704c08d1c5/2bc4a/05.png 295w,
/static/05bb2784942cbe74fc94d0704c08d1c5/fb8a0/05.png 590w,
/static/05bb2784942cbe74fc94d0704c08d1c5/526de/05.png 885w,
/static/05bb2784942cbe74fc94d0704c08d1c5/fa2eb/05.png 1180w,
/static/05bb2784942cbe74fc94d0704c08d1c5/0a94b/05.png 1724w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>当下载完QP 包之后，并不能直接替换，因为当一个QP 包被使用过之后，如果马上替换，可能会出现第一个页面和第二个页面使用了不同版本QP 包的情况，在两个版本不兼容的情况下，将会引起线上故障，所以替换需要定一个时机。</p>
<ul>
<li>当QP 包未被使用过，则下载完就直接替换达到可使用状态。</li>
<li>当QP 包已经被使用过了，下载完之后先放到缓存目录，等替换时机（图上有）出现了，再替换。</li>
</ul>
<h4>2、任意网络下的单项更新</h4>
<p>任意网络下的单项更新，从字面意思就比较好理解，唯一需要明确的是，在打开一个项目的时候，我怎么知道要更新哪个呢？我们的解决方案是，在请求的url 上，加hybridId 参数，通过hybridId 参数就可以知道要单独更新哪个包。 例如：</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">https://ued.qunar.com?hybridId=test</code></pre></div>
<p>单项更新将不会区分网络，在任意网络都会进行，具体如下图所示： </p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/bf3f2ab33619b71a6c93031bd2794a6e/08f6a/06.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 37.85310734463277%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAABSElEQVQY031RTUsCQRie31GHOtehS7d+UTehgjCMIEE6RBZ08RSRsSRWYokUHYyoyI+i1eyQ5SEpTHf2a3ZnZ3dmGtkt+wAfnsP7zvs+PDPPAP4bjHPKWFD3CtYfUcoFv6eUgo3TavxEbrQ10UPkRPZLsaM7i7j+hvzUWj8ux3OVZKGGLZs62DYMU1WRrnkWAsOh5FBoR7qscxdPb51PhPfG5qXF9I1liqVuIl8enZPGF1JT0cxrW4EKbDy/yNVqrV7XFQWsZEuxTOmx1RU+b9CY2S5EpAuIbEKI5+DiQ3M5fbWaLW7mb01kEYx1VTU0TYVQ63yAP28WGlPtUI8EvSfuT30y12Uu4a7bO/Q8RggQ8fgUmwrC4dR19LCo28QPj/Wl/D8CZ1/c7Ogjs7uTSwfvKvpKexDAj1/hmuWs5SqJs3uEA+fB+ARRCLJONP64JAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/bf3f2ab33619b71a6c93031bd2794a6e/fb8a0/06.png"
        srcset="/static/bf3f2ab33619b71a6c93031bd2794a6e/1a291/06.png 148w,
/static/bf3f2ab33619b71a6c93031bd2794a6e/2bc4a/06.png 295w,
/static/bf3f2ab33619b71a6c93031bd2794a6e/fb8a0/06.png 590w,
/static/bf3f2ab33619b71a6c93031bd2794a6e/526de/06.png 885w,
/static/bf3f2ab33619b71a6c93031bd2794a6e/fa2eb/06.png 1180w,
/static/bf3f2ab33619b71a6c93031bd2794a6e/08f6a/06.png 1770w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>上图红框圈住的地方，将会有页面的加载逻辑，包括强制更新以及是否下线的判断，后续再进一步说明，我们先看下在正常情况下的流程，如下图所示。 </p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/c7bc2/07.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 68.08510638297872%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQoz41SXWvTUBjuz/FvjAn6AxzIQG9kxVs38NYhSEV/QJ20ZfamK0NZYZci2vjRqruZbjHpggW3rG2SrWlOcnK+fdO4tnFFfHhOAu95n/d9zntOTimpUkihLiCExIRhwgPMUkYkIedSzSAHK9prxMb7sT4B/CmDQvKTNbq3ZT1odNfqVq09gDhhIiP2Xz10n153H18N3myAzvODEMeEQpJoWf5a3VxvWKtbZq3dg+wgJIRycHAh3nnkFhbcwmLwtkw5uKWEMoSpENzoRaWmvfnhtKLZmjkELzHlQiY5U9tob5cctVLbaZQmtWXTPF95od8u60vFg4139sR2TNgfsRQCK3VOeITjvwY2ROSXg4593h2Ejo8hwnhWDIszRuKQc6YuQwrZ0xWLZ2NT8fZXp9bu1z87u/seE5Kn5AJ6sNAPXhfdJ9f8l+vc78NVecNR5szLzw9vlQ5vFL/nqwZMEk6bkFKiVGi04Ba8woJz/wr6sgPdURjBbmo+ERs2+mEj/QT9dMKs4WR4+LRzVr5LzI+z48w8kn+DCBXL+Vs5IdWE067jL6Z8MCLd/sg89lDM54jnlhRjh1pnmK92VqpHy6VOSetN4v8lbhpndyoH+U395rNvFe3ksvg3TF0KOCXK8voAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/fb8a0/07.png"
        srcset="/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/1a291/07.png 148w,
/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/2bc4a/07.png 295w,
/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/fb8a0/07.png 590w,
/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/526de/07.png 885w,
/static/d8ec04fc2671fd62e2e7cb00c8b34f2f/c7bc2/07.png 1128w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h4>3、强制更新</h4>
<p>强制更新是为了解决出了故障或者希望某个版本（业务做活动）的QP 包能快速被更新到而设计的功能，使用起来也相当简单，只需要在发布QP 包的时候，选中强制更新选项即可。</p>
<p>原理其实就是对当前发布版本的QP 包做一个强更的标记，客户端在检查更新的时候，获取到这个标记之后，会缓存下来，直到打开业务页面的时候，查一下缓存，如果是强制更新，就先更新完再进业务，打开业务页面时的流程，如下图所示。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/23cabb4bccead77593a4a26d332b5bd1/8c9ea/08.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 58.675496688741724%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABw0lEQVQoz42RzUvcQBjG9z9qQRBPnnv3bi/F0kPFg7eq3eKh9QMsVD3IinqwW6hQq1JF+oEWy7agKLvuR9egu8km0SRuviaZSebDSVaX3YrSh5nkZd758T4Pk2CM0RChs0NGKa9RgEsyyMuudAlZLIoAFP4wgjHhOxQNWJRBWfVCTBMUh9bKiD7SYW+/syyzeKb2p4UnS+XxzSqjBGg1c/GZPvTQXhnWFEkUxcmtyvO00P9BMNwwgu211/qrLvv7HJ9T1ZzeVK5nNpdcPcEBcjTZSg9eJjvBxhvkuQj6Lz+d9MxkH8/ndSdIRMZwENQKDdsBJn8V9+NvNSc5UYuvwK8XM64HQ0z4iWh4Rdkpq25ku5Er/lB2o7EvYlYCvCARTS8UWatbAADWrsT1v4Xk5fhW7VdB4SGB43g/F+oTj8LsZrPbWC1wi/j51Ddp71jyfM88+qonO/UXDy5Gu5Fcitvk1uR2DX8+PahEmflFP79jzvcRpfSPwTvhp0v5jGA2MxumXXchguiOzO1a3Veqhh9P4vmIqp7rmgYh/C+4adD08Oh6ZeB9efrHOaHNh7kXJjQSLxwfp3Zrb7cryxmFxHQrfAX64JS1LQlbkAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/23cabb4bccead77593a4a26d332b5bd1/fb8a0/08.png"
        srcset="/static/23cabb4bccead77593a4a26d332b5bd1/1a291/08.png 148w,
/static/23cabb4bccead77593a4a26d332b5bd1/2bc4a/08.png 295w,
/static/23cabb4bccead77593a4a26d332b5bd1/fb8a0/08.png 590w,
/static/23cabb4bccead77593a4a26d332b5bd1/526de/08.png 885w,
/static/23cabb4bccead77593a4a26d332b5bd1/fa2eb/08.png 1180w,
/static/23cabb4bccead77593a4a26d332b5bd1/8c9ea/08.png 1510w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>我们为了保证页面打开的速度，没有在每次打开页面都去检查是否强更，而是通过一个论循的方式，每隔5分钟全量检查一次更新，然后将检查结果进行缓存。这样做的目的是因为，检查更新需要耗时，而我们期望更快的页面打开速度，不想因为少部分的更新情况而让所有用户所有时间都去先检查一次更新，所以我们的强更方案是牺牲部分更新率的，如下图所示。</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/904522cecfa19140c15d5abe2e583b5f/6ad97/09.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 54.400000000000006%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABOklEQVQoz6VQTUvDQBDNn/HkvRfxh/ToD/As3lTq0Vtz9CIK2oq2eDBgUURFsGooBauYqmRTG5qYtMnuZrPJrm4SFb/AiI9lGN7Mm9l50vM/IA1xWG121041pQ3iFOVGe3r1RO32RZnFjEVMJPdXj5ty4/KwI3LO38Q3fXdysV6Y3yrKexAiCGGxrIzNrCsXdzwIachCHIm+/UpzqjC3XNpOxa9qiXHu+tgeIR+HGXV83Vs5aGnAJAFOlrNkM7g1K7KiHnUyhqeQfjwmIoFjW0+OYw0GnudRSgUZEMw5+3Tzd6UYGTPxkvHCgmyP4C3LNoCh67phJNE0TSm/txhB5PvASCCUhJC84ojxnuViGv/y7S8QJ4i4oz5MlGpLu63EsHe3c4qrZ9r47MZC7fxv4qwREQrs0RCRj6UX3Ohuhg5ygt4AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/904522cecfa19140c15d5abe2e583b5f/fb8a0/09.png"
        srcset="/static/904522cecfa19140c15d5abe2e583b5f/1a291/09.png 148w,
/static/904522cecfa19140c15d5abe2e583b5f/2bc4a/09.png 295w,
/static/904522cecfa19140c15d5abe2e583b5f/fb8a0/09.png 590w,
/static/904522cecfa19140c15d5abe2e583b5f/526de/09.png 885w,
/static/904522cecfa19140c15d5abe2e583b5f/fa2eb/09.png 1180w,
/static/904522cecfa19140c15d5abe2e583b5f/6ad97/09.png 1750w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>从数据统计情况来看，强更的效果也是相当明显。</p>
<ul>
<li>普通更新，会比较慢，每个项目情况不同，长尾效应也比较长，统计如下图所示。 </li>
</ul>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/d6cb3e218a7c9a26fa6634948fb53caa/6438f/10.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 40.067720090293456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAA9klEQVQY021RCWrEMAzM/39YKIXCLj2Cc9myrMNOx8m2NLTDeBCyRsjyYGZEWQ64+b7v7Q96Dmd/ABlV+GzAqbXuvy7qFbg3rfw28W0sH7OMS562lBnoZqB7/Ki70v1o0JrcR3565Zc7P9/ibfS9mMmgqiL6Xdd64X9zVy4WVh1nD5vF5JW72dwVb20N08N+6tnlhw//8WxQYVAsSDG2ujPmqpW9ltoEamh8ITLFq5wByac6mcvgbikFookoJJrATHPO4Eq0EDQvCJDvQU/OYXmPKWRe+8KYSynCRaD4tnlatphi3CJ0WxGkBE05HytmzqylaBH5AiMX0uPeHMbrAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/d6cb3e218a7c9a26fa6634948fb53caa/fb8a0/10.png"
        srcset="/static/d6cb3e218a7c9a26fa6634948fb53caa/1a291/10.png 148w,
/static/d6cb3e218a7c9a26fa6634948fb53caa/2bc4a/10.png 295w,
/static/d6cb3e218a7c9a26fa6634948fb53caa/fb8a0/10.png 590w,
/static/d6cb3e218a7c9a26fa6634948fb53caa/526de/10.png 885w,
/static/d6cb3e218a7c9a26fa6634948fb53caa/fa2eb/10.png 1180w,
/static/d6cb3e218a7c9a26fa6634948fb53caa/08f6a/10.png 1770w,
/static/d6cb3e218a7c9a26fa6634948fb53caa/6438f/10.png 1772w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<ul>
<li>强制更新，不管是iOS 和Adr 在2小时内达到了<code class="language-text">90%</code>以上的更新率，这比起普通的更新实在快太多了，统计如下图所示。 </li>
</ul>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/static/f3ba211f0d166eea7ff646046a5f5650/6b333/11.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 39.00789177001128%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsSAAALEgHS3X78AAAA7UlEQVQY03VR0U4EIQzc//9CjZfoqdHEXffULW0p0HUouuYenExKIZ12gMndmSUHWmv7P/CDDro3LPsEQSnFA8hrq0A/rAVsARxkUktBzsWqlYr6CYWa1WoJWtcUs66EpI4WKplPT3J7lrtHuX+pxGN8n5zN2i/G/CMO4Ea2fur5VU7PfPOAPPz7tW2H7TZs9xugQ2/Su8NBdz+SXtV+xPB7vMNf3H0cgpBgvXq/2EJcaVsSzWmbIy5pe2NamFZJK6d35LTNzKvIhUH96JQLHE9xJTWLvzIYzKpCRCl9pYgiZIYCzWDGpyKqKsPyN00U1KNyOwtJAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="image"
        title=""
        src="/static/f3ba211f0d166eea7ff646046a5f5650/fb8a0/11.png"
        srcset="/static/f3ba211f0d166eea7ff646046a5f5650/1a291/11.png 148w,
/static/f3ba211f0d166eea7ff646046a5f5650/2bc4a/11.png 295w,
/static/f3ba211f0d166eea7ff646046a5f5650/fb8a0/11.png 590w,
/static/f3ba211f0d166eea7ff646046a5f5650/526de/11.png 885w,
/static/f3ba211f0d166eea7ff646046a5f5650/fa2eb/11.png 1180w,
/static/f3ba211f0d166eea7ff646046a5f5650/08f6a/11.png 1770w,
/static/f3ba211f0d166eea7ff646046a5f5650/6b333/11.png 1774w"
        sizes="(max-width: 590px) 100vw, 590px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>从上图也可以强制更新并没有达到<code class="language-text">100%</code>的更新率，我们基于性能以及用户体验考虑，只能无限接近<code class="language-text">100%</code>的。</p>
<h2>4、下线回滚</h2>
<p>强更解决了更新率低的问题，但是当遇到线上故障，我们还没有新版本能发布的情况下，我们希望能下线出问题的版本，同时能回滚到可用的版本。早期我们采用的方式是，回滚代码，重新发布QP 包，用新的版本去覆盖老版本，这种策略执行起来不但耗时，而且因为更新率不能达到100%，导致问题版本一直存在。</p>
<p>要做好下线回滚，不能只从服务端做，而需要客户端配合一起实现，这样才能做到客户端和服务端同时下线。</p>
<p>下面举例说明，假设一个项目hybridId 是hybridIdTest，本地QP 包的版本号为99，当客户端客户端发起检查更新请求时，参数如下：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    hybridId<span class="token operator">:</span> <span class="token string">"hybridIdTest"</span><span class="token punctuation">,</span>
    QPVersion<span class="token operator">:</span> <span class="token number">99</span>
<span class="token punctuation">}</span></code></pre></div>
<p>请求结果如下：</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    message<span class="token operator">:</span> <span class="token string">"成功"</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
        hlist<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                hybridId<span class="token operator">:</span> <span class="token string">"hybridIdTest"</span><span class="token punctuation">,</span>
                patchUrl<span class="token operator">:</span> <span class="token string">"差分包url"</span><span class="token punctuation">,</span>
                md5<span class="token operator">:</span> <span class="token string">"rsa加密的md5值"</span><span class="token punctuation">,</span>
                url<span class="token operator">:</span> <span class="token string">"全量包url"</span><span class="token punctuation">,</span>
                version<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        offlineHlist<span class="token operator">:</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                hybridId<span class="token operator">:</span> <span class="token string">"hybridIdTest"</span><span class="token punctuation">,</span>
                version<span class="token operator">:</span> <span class="token number">99</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>在<code class="language-text">offlineHlist</code>字段中，包含了<code class="language-text">hybridId=hybridIdTest，version=99</code>的条目，说明<code class="language-text">99</code>版本已经在服务端下线了。数据<code class="language-text">hlist</code>部分给出了版本号<code class="language-text">100</code>的下载地址。当客户端要加载页面时，如果本地版本号还是<code class="language-text">99</code>，那么就要将版本<code class="language-text">99</code>的QP 包标记为失效，然后下载版本<code class="language-text">100</code>的QP 包。</p>
<p>总之就是当后台对一个项目的某个版本下线之后，客户端在发起请求的时候，会拿到<code class="language-text">offlineHlist</code> 字段，在加载页面的时候，会采取对下线版本失效的处理。这样就达到了服务端和客户端同时下线的目的。</p>
<p>最后再看下如何回滚，当客户端能接收比本地版本低的新包，这样服务端可以下发合适当前客户端版本的没有下线的最新QP 包，从而达到回滚的目的。</p>
<h2>总结</h2>
<p>本文分享了QRN 的更新方案，从最小可用方案到遇到问题衍生出一套完善的更新机制，并且得到了大量实践检验。限于篇幅所限，并没有进一步深入细节，其实要让整个方案可靠且方便使用，还有更多的环节，就QRN 更新方案来说，我们在调试工具，发布系统，打包脚本等等环节都有大量投入。</p>
<p>最后，希望本文可以抛砖引玉，带来更多思考以及好问题。</p></div><hr style="margin-bottom:1.75rem"/><div style="display:flex;margin-bottom:1.75rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQBBQb/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAAB6PK9DMNbCZEFcG//xAAZEAADAQEBAAAAAAAAAAAAAAAAAQIEAxD/2gAIAQEAAQUC11S453c9RkVPjM6SZ//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAdEAABBAIDAAAAAAAAAAAAAAABAhARIQASIjFB/9oACAEBAAY/AuHeJgqtzpCr8cwA3//EABsQAQACAwEBAAAAAAAAAAAAAAERIQAQMUFR/9oACAEBAAE/IU1pPT5kqr2JUa45OQG18LmqDgKCQaNf/9oADAMBAAIAAwAAABCMz/z/xAAXEQEBAQEAAAAAAAAAAAAAAAABECEx/9oACAEDAQE/EABsOT//xAAYEQACAwAAAAAAAAAAAAAAAAABEBEhMf/aAAgBAgEBPxC5R1f/xAAcEAEBAAMAAwEAAAAAAAAAAAABEQAxQRAhYVH/2gAIAQEAAT8QtkQOw6n3J0Mr9L6u89ZfpAd3hkBvo1DqvO+EqOC4QNcgVr+eP//Z" alt="gtts" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition:opacity 0.5s;transition-delay:0.25s"/><noscript><picture><source srcSet="/static/ece4cf964bea4a5a974e06fa1fac2005/d2d31/profile-pic.jpg 1x,
/static/ece4cf964bea4a5a974e06fa1fac2005/0b804/profile-pic.jpg 1.5x,
/static/ece4cf964bea4a5a974e06fa1fac2005/753c3/profile-pic.jpg 2x" /><img width="50" height="50" src="/static/ece4cf964bea4a5a974e06fa1fac2005/d2d31/profile-pic.jpg" alt="gtts" style="position:absolute;top:0;left:0;transition:opacity 0.5s;transition-delay:0.5s;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>人生没有白走的路，每一步都算数<br/> <a href="https://www.github.com/mcgtts">我的github</a></p></div><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li></li><li><a rel="next" href="/2018-12-26---new-born/">2019，全新的开始<!-- --> →</a></li></ul><footer>© 2018, Built with <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-37175174-2', 'auto', {});
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2018-08-10-qrn-update-3b0","path":"/2018-08-10---qrn-update/"};window.dataPath="233/path---2018-08-10-qrn-update-3-b-0-544-Sie4oUx6YwJRqr1TEws91yhQc";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.c0f892a0ecdf2a427017.css","/app-d87cf20a72d107b4f99a.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-7fb03748f6b5c94581e7.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-a7f689111f7c2a79dcfc.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b929127f0a4f05a962a9.js"],"component---src-pages-index-js":["/component---src-pages-index-js-87cb54350433d05f4e37.js"],"component---src-pages-test-1-js":["/component---src-pages-test-1-js-57d68bc74c45e783b568.js"],"pages-manifest":["/pages-manifest-6929a99c9e4ba061391d.js"]};/*]]>*/</script><script src="/webpack-runtime-364d645fac78fecf4cff.js" async=""></script><script src="/app-d87cf20a72d107b4f99a.js" async=""></script><script src="/0-d14fd4fa07a09eb3740f.js" async=""></script><script src="/component---src-templates-blog-post-js-a7f689111f7c2a79dcfc.js" async=""></script></body></html>